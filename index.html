<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Midjourney AI Art</title>
  <meta property="og:image" content="https://mj-gallery.com/9c8420b0-4a42-45c9-8d87-414a89f7b304/grid_0_384_N.webp"/>
  <meta property="og:description" content="Gallery of art generated through Midjourney AI" />
  <style>
    html {
      /* inline background noise. No network request/failure possible */
      background-image: url(data:image/png;base64,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);
      background-color: rgb(1 5 19);
      /*background: repeating-linear-gradient(#e66465 0%, #9198e5 5%);*/ /* for debugging background/scroll movement */
    }
    body {
      overflow-x: hidden;
    }
    .box {
      position: absolute;
      top: 0;
      left: 0;
      overflow: hidden;
      background-color: rgb(34, 36, 53);
      border-radius: 16px;
      box-shadow:
        0 0px 2px 0 rgba(255, 255, 255, 0.2),
        0 4px 28px 0 rgba(0, 0, 0, 0.4);
      background-size: 100%; /* low-res image added as background-image in JS later */
      background-repeat: no-repeat; /* just in case of floating point whatever */
    }
    .box img {
      display: block; /* prevent inline-block from adding whitespaces... */
      width: 100%;
      border-radius: 16px 16px 0 0; /* safari forgets border-radius occlusion from box container when lifting img onto GPU */
    }
    .prompt {
      position: absolute; /* rest near bottom even when image isn't loaded yet */
      width: 100%;
      box-sizing: border-box;
      padding: 8px 12px 8px 12px;
      overflow: hidden;
      font-family: "DM Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; /* same as midjourney's */
      color: rgb(192, 198, 205);
      font-size: 16px;
      cursor: text; /* override parent .box's zoom cursor */
      /* for line clamping programmatically */
      display: -webkit-box;
      -webkit-box-orient: vertical;
    }
    .prompt:before {
      content: '‚ùù';
      color: rgb(122, 126, 130);
      padding-right: 2px;
    }
  </style>
</head>

<body>

<script>
'use strict'

function clamp(min, v, max) {
  return v > max ? max : v < min ? min : v
}

const promptSizeY = 47 // magic number. Doesn't show the 3rd line nor cuts the 2nd line on safari, mobile safari and chrome
const prompt1DSizeY = 64 // size in 1d mode
const promptGapBottom = 8
const boxesGapX = 24, boxesGapY = 24
const boxes1DGapX = 52, boxes1DGapY = 28
// 4ms for the spring animation's step. Typically 4 steps for 60fps and 2 for 120fps (frame time delta varies, so not always true)
// could use 8ms instead but 120 means 8.33 ms per second, and the computation here doesn't fit in 0.33ms, which means sometime the simulation step wouldn't even run once, giving the illusion of jank
const simulationStep = 4

function colsBoxMaxSizeXF(containerSizeX) {
  const boxMinSizeX = 220 // Make sure that on mobile, this min width is big enough not to show 2 images per row. Also, this won't be respected if view's tiny
  const cols = clamp(1, Math.floor((containerSizeX - boxesGapX) / (boxMinSizeX + boxesGapX)), 7) // boxesGapX for body's left and right too
  const boxMaxSizeX = (containerSizeX - boxesGapX - cols * boxesGapX) / cols
  return {cols, boxMaxSizeX}
}

let data; {
  const windowSizeX = document.documentElement.clientWidth
  const windowSizeY = document.documentElement.clientHeight
  const {cols, boxMaxSizeX} = colsBoxMaxSizeXF(windowSizeX)
  const imgMaxSizeY = boxMaxSizeX + 100 // TODO: adjust this better
  data = [
    {id: 'adae74c4-65c5-4245-87e1-c0fbc81c2c27', w: 1024, h: 1792, prompt: `liquid gold melting over white bird skull mask, cyberpunk rococo`},
    {id: 'f0485122-e83e-492c-aa63-42a28015e45d', w: 1664, h: 2432, prompt: `futuristic soldier with bird skull mask, rococo`},
    {id: '8a8f7373-d0b2-4ea4-a3ff-a93e312d1aaf', w: 1664, h: 2432, prompt: `skull knight, rococo`},
    {id: '9589827f-4904-4dd8-a5a4-4fcc7a9c93f1', w: 2304, h: 1536, prompt: `grim rococo skulls`},
    {id: '6663e462-eba5-4a62-b914-5dc62d8be269', w: 2048, h: 2048, prompt: `tiny comfy vertical house in the valley of sunshine and flowers`},
    {id: '20fb2780-14bc-44af-8fee-bce4da244f9e', w: 2304, h: 1536, prompt: `rainy fall, happy tree frog on a leaf, close up high-resolution macrophotography`},
    {id: 'acc8432d-fc61-4346-8aee-961d4a51aa6d', w: 2048, h: 2048, prompt: `delicious chocolate cake keyboard`},
    {id: '3beb7a37-30a0-4c77-8940-24b0190768ab', w: 1024, h: 2048, prompt: `giant futuristic desert city over deep ocean ecosystem, red starry milky way, split screen photography`},
    {id: 'fdd3566a-9cfb-4b11-8733-b54827479c27', w: 1664, h: 2432, prompt: `ocean ecosystem, giant futuristic desert city, red starry milky way, split screen photography`},
    {id: 'f9adb8e0-0a1e-4015-bcc2-7664bc8cc6ca', w: 1664, h: 2432, prompt: `time lapse photography, cityscape nightlife, akira retro anime poster aesthetic, high contrast saturation`},
    {id: 'c43a2093-07df-4ea6-866a-f1204ed7aa4b', w: 2304, h: 1536, prompt: `mystical connected forest villages`},
    {id: 'ea74fc47-dacd-4ddd-afb0-8b9a30589272', w: 2304, h: 1536, prompt: `blindfolded woman, golden river of time, intricate ornaments, 8k render`},
    {id: 'e8bfe061-f510-4269-90f9-e789b4d29209', w: 2048, h: 2048, prompt: `baby wrapped in cabbage leaves`},
    {id: 'c90dde4f-47bd-41bc-9574-2a85a5b51a52', w: 1024, h: 1536, prompt: `beautiful focaccia vegetable pattern, seamlessly repeating`},
    {id: 'fda63c22-f6ff-4ad8-bee2-2e197fbc0a97', w: 2048, h: 1024, prompt: `kid's back, low angle, staring up at floating temple in ancient china`},
    {id: '7d2393c5-6785-40db-bbea-19fa78b564ec', w: 2048, h: 1024, prompt: `kid's back, low angle, staring up at mobius spaceship landing in ancient china`},
    {id: '96ea994a-9356-4b2a-ae2a-debfc8d9f5be', w: 1664, h: 2432, prompt: `futuristic red & gold demon samurai mask resting on grass, highly detailed, exquisite decoration, symmetric, 8k render`},
    {id: '135a44e0-b790-4db7-b10c-084588fc12bd', w: 1664, h: 2432, prompt: `futuristic demon samurai mask in glass display, highly detailed, exquisite decoration, symmetric, 8k render`},
    {id: '33341a99-5ac6-44df-8812-a819b9a2ff07', w: 1664, h: 2432, prompt: `futuristic demon samurai mask, highly detailed, exquisite decoration, symmetric, 8k render`},
    {id: '4db303cb-c03c-4dc4-ad09-5a81a4643442', w: 2048, h: 2048, prompt: `virgin killer sweater`},
    {id: 'f637833b-9a01-4d26-9ada-8501fa4c2802', w: 2048, h: 2048, prompt: `beautiful iOS health schedule app icon, saturated`},
    {id: '25c83d8f-8186-423f-aff3-f8ee0e0e8c5c', w: 1024, h: 1024, prompt: `intricate anthropomorphic branches compass from fairy tales`},
    {id: '591259df-d807-40f9-92f7-36f2b74d2418', w: 1024, h: 1024, prompt: `intricate magical compass from fairy tales`},
    {id: 'b6fa5204-940c-474a-b345-e329f8f961b1', w: 1024, h: 1536, prompt: `medieval squirrel outfit, pointillism`},
    {id: '46eba778-bd08-4144-80d9-48f7646aad01', w: 1536, h: 1024, prompt: `paper mario flower shop stage montage`},
    {id: '35c8ec01-5884-49ed-8b41-b70710355bfc', w: 1536, h: 1024, prompt: `paper mario train station stage, decorated`},
    {id: '68016c33-b0b6-4a0c-839b-c09d14119c39', w: 2304, h: 1536, prompt: `elegant Roger Federer, red and white`},
    {id: '5714f9fb-2672-4e9e-a794-19926e047b06', w: 2048, h: 2048, prompt: `yellow and red maples pattern, volumetric lighting, octane renderer, tilt shift`},
    {id: '0ed3fce9-6eda-4d1c-b559-b77bd4444a08', w: 1024, h: 1024, prompt: `roger federer, red and white, high contrast`},
    {id: '9e3baa7d-e892-4e4a-892e-84fd654a06cb', w: 1664, h: 2432, prompt: `mirror reflection of a little boy crying`},
    {id: 'b51b0831-5384-4980-9c50-77079339cb4f', w: 1664, h: 2432, prompt: `silent boy crying in front of a mirror`},
    {id: '59f9b49a-c731-4167-9dda-1a652ed30266', w: 2048, h: 2048, prompt: `zebra jail bars`},
    {id: '2db19bdc-ec21-4a68-8dba-172212933841', w: 2048, h: 2048, prompt: `flying fish`},
    {id: '5c196f49-6572-40b9-8529-16350d9cfc13', w: 2048, h: 1024, prompt: `5 centimeters per second, toy renderer, 3D cel shading`},
    {id: '596808d3-8550-497b-bbf7-e16df6ba9a43', w: 2048, h: 1024, prompt: `5 centimeters per second, unity cel shading, curvilinear lens`},
    {id: '5c059f02-01ae-4606-8e81-a39df281b97b', w: 2048, h: 1024, prompt: `5 centimeters per second, trains, unity cel shading render, fisheye`},
    {id: '90a1b52f-5e4f-4d8b-99af-3c5cd59bf434', w: 1024, h: 1024, prompt: `irridescent terrine`},
    {id: 'e20f7450-a289-44d5-9b83-b5a0b9fedc37', w: 2048, h: 1024, prompt: `rainbow cloud bent toward the mountain, makoto shinkai`},
    {id: '6b777018-edb8-4a76-be36-8a78652a3199', w: 1664, h: 2432, prompt: `the happiest anthropomorphic mushroom dancing in morning dew with her friends, 3D game concept art render, volumetric lighting`},
    {id: '3d637738-3996-46d0-b2c3-0af14863322b', w: 1408, h: 2816, prompt: `the happiest mushroom growing in the morning dew with her friends, 3D game concept art render, volumetric lighting`},
    {id: 'a437c15a-5e3e-42b7-9299-3b1188b40020', w: 2048, h: 1024, prompt: `galaxy rainbow, high resolution fisheye lens, long exposure photography`},
    {id: '60d99de5-dd01-4f3d-870d-2f957a409d91', w: 2304, h: 1536, prompt: `confucius performing the miracle of turning water into boba in front of his family, chinese ink painting`},
    {id: '81600ebb-7d32-4660-a3ec-34c6684926a9', w: 1024, h: 1024, prompt: `wormhole portal to moon in a mirror, god rays`},
    {id: '932eae0c-ed04-4616-8750-e8d29d4cc78b', w: 2304, h: 1536, prompt: `silver filligree pearl-encrusted tissue box, intricate details, resting on purple velvet fabric, 8k macrophotography`},
    {id: 'fcb1286b-fc40-46bb-a3ce-51bed7232622', w: 1024, h: 1536, prompt: `daft punk style mirror helmet reflecting planet earth, man in tuxedo looking down against a galaxy background, dynamic angle`},
    {id: '3dae2556-b910-4a9c-8c41-0578472b8e7f', w: 2048, h: 2048, prompt: `white tshirt with words "I heart MJ"`},
    {id: 'cb5f8b4c-e6dc-4bc0-827f-c330093f2827', w: 1664, h: 2432, prompt: `peacock feather eyed human portrait, dynamic angle, extremely detailed 8k`},
    {id: 'da3cc4f1-2024-40fd-83b6-36c41fa6ca66', w: 2304, h: 1536, prompt: `silver filligree pearl-encrusted tissue box, intricate details, resting on purple velvet fabric, 8k macrophotography`},
    {id: 'dc2ca067-e202-49d3-ac0c-b60f14ea5b3d', w: 2048, h: 1152, prompt: `magnificent gilded palace hallway, high ornamented ceiling, tall murals with display artifacts, luxurious crimson ornaments, extremely detailed, golden volumetric lighting, well lit, 8k render, low angle, sumptuous scale`},
    {id: '05447686-85b8-49a3-8ed7-d3ee5b0ebe0c', w: 1792, h: 1024, prompt: `Lu Bu riding his motorcycle into the battlefield, traditional chinese painting`},
    {id: '6228d5ef-c902-484a-a8b5-4cfc696bd07d', w: 1024, h: 1792, prompt: `warrior Lu Bu in slick corporate suit closing a real estate deal, low angle`},
    {id: '4bc25b4f-87e2-432b-b0ff-ed4cbab67951', w: 1536, h: 1024, prompt: `art nouveau bento lunch`},
    {id: '06b16ea2-3f09-45fe-b4ab-66db853f4583', w: 2304, h: 1536, prompt: `colorful vibrant micro ecosystem growing on an iphone`},
    {id: 'f14eb017-5655-4013-8b9f-b22c3edf35d8', w: 1536, h: 2688, prompt: `art nouveau iOS springboard square icons grid interface`},
    {id: '52e76a58-1d26-455f-92d9-d79f50931453', w: 2048, h: 2048, prompt: `art nouveau ios icon, detailed, square, floral, 3D render`},
    {id: '4408292b-2828-40cf-a81d-9a186a43e53e', w: 2304, h: 1664, prompt: `real buildings on a giant monopoly board table, cards, hyperrealistic, tilt shift`},
    {id: 'fbd2c6b6-eb92-4ce8-89e9-c0e040296c4c', w: 1664, h: 2432, prompt: `audrey hepburn in female darth vader suit`},
    {id: 'f951cb42-775f-4e54-be98-58e651e18d30', w: 1664, h: 2432, prompt: `audrey hepburn in female vader suit, elegant pose, pipe saber`},
    {id: '4f17d6e2-fd63-484b-977d-e27916d5d5d1', w: 1664, h: 2432, prompt: `audrey hepburn in female vader suit, elegant pose, pipe saber`},
    {id: 'f73be0ac-6c25-4b7a-a878-8fe13a6d69d9', w: 2048, h: 2048, prompt: `pikachu in a gacha ball`},
    {id: 'e3542b15-1f1c-446a-8f3b-1418760477c0', w: 2048, h: 2048, prompt: `pikachu in a gacha ball`},
    {id: 'ed43f1b8-88fb-43eb-b0cc-7e785ecb6b41', w: 1024, h: 1792, prompt: `sagrada familia corn`},
    {id: 'e59e0649-140e-4c6a-aa91-4697dd402729', w: 1024, h: 1792, prompt: `tetris world :: tetris T block, octane renderer, god ray, sky`},
    {id: '719c4930-70c3-4855-b212-8f8e14c4c3c0', w: 1024, h: 1792, prompt: `hyperrealistic tetris blocks dropping down in grid formation, octane render, bottom-up perspective, sky, god ray`},
    {id: '8ea1568b-2dca-4279-96e3-2d52fd276597', w: 2048, h: 1024, prompt: `river of flamey hair, faded colored manga, xxxholic style`},
    {id: 'ad4ad020-52d1-4305-ad23-306647acc495', w: 1536, h: 1024, prompt: `giant mosquito queen sitting relaxing near incense, xxxholic style`},
    {id: '43d51329-276e-4260-8bd5-53220ff4b023', w: 1536, h: 1024, prompt: `iridescent damascus steel clover`},
    {id: '884ff494-0be6-44ad-96c6-a7504cbfbd50', w: 1536, h: 1024, prompt: `iridescent damascus steel leaf`},
    {id: '3781e6d1-a1d5-42e9-b490-49c0981d2aab', w: 1792, h: 1024, prompt: `festival, colorful smokes, giant balls, dark blue sky, dancing people in colorful flowing clothes, chaotic dreamy`},
    {id: '30d2ccee-488e-47ff-b9b6-17f1997faa10', w: 2304, h: 1536, prompt: `amigurumi baby shark in a woven basket, autumn forest morning, dust particle shining in sunlight, high resolution, macrophotography`},
    {id: 'dcad37ca-642e-41c4-975d-92eb50c4a2f8', w: 2304, h: 1536, prompt: `Everything everywhere all at once`},
    {id: 'c3e0d7e3-cf2d-471c-ae00-94ab4813d312', w: 1664, h: 2432, prompt: `quiet garden path, woman sitting in a chair, another empty chair`},
    {id: '7f740b3c-86d4-42ba-91c8-230da6ab348d', w: 1024, h: 1024, prompt: `united starbucks of america`},
    {id: 'a765e305-43c1-47a9-a145-63cb0ad15fea', w: 1664, h: 2432, prompt: `portrait of a smiling young asian woman, double eyelids, big eyes, long brown hair with side swept bang, round face, thin yellow headband, white shirt with lightblue sailor collar, high resolution`},
    {id: 'b1c0c023-658a-4a9d-aae0-885014704bbf', w: 1664, h: 2432, prompt: `portrait of a smiling young asian woman, double eyelids, big eyes, long brown hair with side swept bang, round face, optimistic smile, thin yellow headband, white shirt with lightblue sailor collar`},
    {id: '16f75d7e-4308-4f66-b910-7a6a0ca3329e', w: 1664, h: 2432, prompt: `jeff bezos as one punch man, shiny bald head, epic, powerful, high resolution hyperrealistic`},
    {id: 'c7991998-c193-47c0-bc28-96c9de7b2d4f', w: 1664, h: 2432, prompt: `portrait of a young asian woman, double eyelids, big eyes, long brown hair with side swept bang, heart-shaped face, optimistic smile, wearing a yellow head band, wearing a white shirt with lightblue sailor collar`},
    {id: 'ff2f9fd1-3bc5-469e-b2b1-054987122eda', w: 1664, h: 2432, prompt: `portrait of a smiling young asian woman, double eyelids, big eyes, long brown hair with side swept bang, round face, thin tied yellow head band, dark cardigan over white shirt`},
    {id: '0bde6126-2b0d-4e43-9d6a-99c678599ffa', w: 1664, h: 2432, prompt: `portrait of a young asian woman, double eyelids, big downturn eyes, long brown hair with side bang, heart-shaped face, optimistic smile, wearing a yellow head band, wearing a white shirt with blue sailor uniform collar`},
    {id: '47809a3c-92e1-4584-ae48-e0addb59a7ba', w: 1664, h: 2432, prompt: `older Steve Jobs, long beard, wrinkled face, confident weary smile, monochrome hyperrealistic portrait`},
    {id: '9d0769cc-09f3-4ca2-8614-c9a4eabb13be', w: 1664, h: 2432, prompt: `older Steve Jobs, long beard, wrinkled face, confident weary smile, monochrome hyperrealistic portrait`},
    {id: '0ae13cc6-e11f-4d8d-9521-64bfd76c8797', w: 1664, h: 2432, prompt: `KFC double down, 8 layers of fried chicken, 7 layers of bacon and cheese`},
    {id: '9fe01d22-c281-4f1a-bb5c-5fa22066900e', w: 1024, h: 1024, prompt: `little red riding gundam`},
    {id: '734f2a21-cdbc-4c54-b832-0b4206879f42', w: 1024, h: 1536, prompt: `lightning waterfall from heaven to earth river, hyperrealistic render`},
    {id: '153a8b3e-59dc-4b92-89ab-640bf683af76', w: 1024, h: 1024, prompt: `trump burger, satirical comic style`},
    {id: '73e9cb44-fa63-4198-a9b3-cd4004f91654', w: 1536, h: 1024, prompt: `giant robot mecha, Ukiyo-e hokusai`},
    {id: '6fea9fd0-a4f0-4b79-886b-ec1ecba3ee81', w: 1024, h: 1536, prompt: `giant robot mecha, Ukiyo-e hokusai`},
    {id: 'a248d49c-749d-49f8-a114-32d809d3d496', w: 2048, h: 1024, prompt: `flight of paper dragons, tolkiens, rendering`},
    {id: 'cc56ea37-74ca-4ca8-bfc1-96bfc8e5a383', w: 1024, h: 1792, prompt: `smoke bonsai sculpture, hilltop, macrophotography, 8k octane render`},
    {id: 'e08b34f6-d03d-4f1e-aa05-e6a1120e5000', w: 1024, h: 1536, prompt: `smoke sculpture maiden silhouette, 8k octane render`},
    {id: '1b843b1d-2451-42ed-a933-76817ef2b736', w: 1024, h: 1536, prompt: `marble smoke sculpture maiden silhouette, 8k octane render`},
    {id: '8f0e0675-ac0a-4615-b222-934de426edc7', w: 1024, h: 1024, prompt: `origami crane made of concrete`},
    {id: 'cdc70000-2af2-42c3-9db3-86fe266ebb0a', w: 1280, h: 1024, prompt: `mapo tofu, fake toy rendering, closed-up diorama, hyperrealistic 8k`},
    {id: '76faee1f-354d-4420-b6d9-39719dbb8d20', w: 1024, h: 1792, prompt: `thick yellow fog invading a small winter town in the morning, yellow sky, diorama`},
    {id: 'e2ce8a73-ab2d-4540-9732-fc4f528c0ca8', w: 1792, h: 1024, prompt: `thick yellow fog invading a small town in winter, diorama`},
    {id: '2a6be313-344d-40ff-b750-ee6e044fafb8', w: 1024, h: 1536, prompt: `melting black vinyl on a modern minimalistic white turntable, 8k octane render`},
    {id: 'ce63122a-5285-417a-9816-b5425c0ff6a8', w: 1024, h: 1536, prompt: `melting vinyl on a modern pearl white turntable, 8k octane render`},
    {id: '3801b82d-294c-4f3f-9c01-68290aed8c37', w: 1024, h: 2048, prompt: `coke sirup dripping down icicle in winter, 45mm film`},
    {id: '6a02df80-6058-4cd9-b583-88f0ede64551', w: 1536, h: 1024, prompt: `kimono omakase`},
    {id: '6898bb0e-2f05-4a41-8bfb-4250a66d8869', w: 2304, h: 1536, prompt: `white seashell shaped apartment interior, light wood floor, futuristic, warm, rendering`},
    {id: '32301d78-6ea6-43af-a095-08eb0f7575e8', w: 1536, h: 1024, prompt: `white seashell residential apartments, futuristic, 3/4 perspective, photorealistic`},
    {id: '536b3830-d144-470b-8c6e-f25f947edc8e', w: 1792, h: 1024, prompt: `swarm of ladybugs flying toward the Milky Way, bottom up perspective, expressionism, Van Gogh`},
    {id: 'f28fcde8-881d-4a75-b827-54f7e535ba44', w: 1792, h: 1024, prompt: `marshmallow modern mansion`},
    {id: '883264da-082c-484c-9eba-ecd0553df0f9', w: 1024, h: 1024, prompt: `straw castle`},
    {id: 'fc444028-779c-44f6-ac74-08fb62e5469a', w: 1024, h: 1280, prompt: `chinese new year on Neptune, in the style of Salvador Dali`},
    {id: '515684a7-715c-48cf-b330-3595fb26e1de', w: 1792, h: 1024, prompt: `dandelion boat`},
    {id: '0c2c63d0-3749-4ae5-998d-7d3338b98cb9', w: 1536, h: 2688, prompt: `koi silk`},
    {id: '901578e9-79a1-43fc-a939-b7c04f5acc0e', w: 1536, h: 2688, prompt: `koi silk`},
    {id: 'bd00d75a-8c11-46bd-a1c6-b43f35a13d5f', w: 2048, h: 1152, prompt: `they're not mountains; they're waves!`},
    {id: 'fc0e3851-6c92-4181-892b-88cadcce6823', w: 1024, h: 1024, prompt: `Apple logo if Tim Cook drew it`},
    {id: 'e35f28a6-4dfc-4248-851b-8d60cfc6b676', w: 1792, h: 1024, prompt: `detailed schematic of instructions on using a pencil`},
    {id: '3205212f-e5d7-44ba-a2e2-e72d44311e4f', w: 1024, h: 1024, prompt: `meiji era painting of a banana katana, ink`},
    {id: '9f184005-9007-4a93-ab6f-49df2a56d8b7', w: 1792, h: 1024, prompt: `Asian farmer kid sitting on old pavement, books on a white sheet, old grainy photo`},
    {id: '5a78f6fe-efea-485d-b0e6-b87c39a50b81', w: 1792, h: 1024, prompt: `spinning space station, in the style of Christopher Nolan, 65mm film`},
    {id: '6f8b0f56-1b88-449c-96e2-bd91d4344cdb', w: 1792, h: 1024, prompt: `Asian farmer kid casting a fishing net, in a muddy rice field, sunrise`},
    {id: '184a98ed-291c-4c27-a711-c8be863095b6', w: 1536, h: 1024, prompt: `glistening gold coins in a dull dark blue trash bag in a dumpster`},
    {id: 'e5fc9b09-dc4e-4410-8bf8-0a03bcfa9235', w: 1024, h: 1024, prompt: `watermelon grape, photo`},
    {id: '693d46f6-0f48-4578-9bb3-8c252a931f8c', w: 1536, h: 1024, prompt: `grainy monochrome photo of an interstellar spaceship in 1950, high resolution`},
    {id: 'a0101172-7c41-4e19-9c64-53442943eb12', w: 1024, h: 1024, prompt: `withered flowers inside a coke bottle`},
    {id: '175ba7de-87f5-4620-9589-fa3a509f9c61', w: 2048, h: 1024, prompt: `closed up gold and green leaf pattern on a fancy gate door, 8k depth of field`},
    {id: '12e9f165-9e0f-4773-8e11-54209e5c02c7', w: 1024, h: 2048, prompt: `macrophotography of flower pattern sculpture, bas-relief, 8k octane renderer`},
    {id: '29bc75c5-65f2-448f-9c6c-560c9e439ed5', w: 1024, h: 2048, prompt: `macrophotography of flower pattern sculpture, bas-relief, 8k octane renderer`},
    {id: '62174480-a054-4f49-a278-76b90744afd4', w: 2688, h: 1536, prompt: `sea of fog over cherry blossom, tilt shift photography`},
    {id: 'c346fa1b-fc5f-49c8-960e-5156947e29bd', w: 1792, h: 1024, prompt: `sea of fog over cherry blossom, tilt shift photography`},
    {id: '7a9b5e5b-7ef2-49d1-8664-a917cce1f784', w: 1792, h: 1024, prompt: `sushi made of stone, 8k octane renderer`},
    {id: 'cfd9b144-dc17-40fe-aab7-3b7bb6d6b52a', w: 1920, h: 1280, prompt: `impossible sushi`},
    {id: 'b317c31b-185f-457a-8f09-c8d088f4c9dd', w: 1792, h: 1024, prompt: `photo of snowman on fire, depth of field, 8k`},
    {id: '64f077d2-ded9-4291-8116-2a7e4edd74f5', w: 1792, h: 1024, prompt: `photo of snowman on fire, depth of field, 8k`},
    {id: 'e987bfc2-0a52-46b9-add6-9537518398d5', w: 1024, h: 1024, prompt: `storm in a teacup, diorama`},
    {id: '586f0bf8-639e-401c-8622-33d1e9736cdb', w: 1024, h: 1024, prompt: `storm in a teacup, origami`},
    {id: '226e635a-d41e-41da-92b1-eac02c4196e5', w: 1024, h: 1024, prompt: `pretty girl`},
    {id: '0f3ea9a2-ad79-491c-87db-3bf7d7bb0547', w: 1024, h: 1024, prompt: `the word "ReScript", clear font, perfect kerning`},
    {id: '9c0a4fea-ae34-4c07-8e77-4aa7a9d5bdc5', w: 2304, h: 1024, prompt: `the four bunnies of apocalypse, dystopian, artstation, high quality render`},
    {id: '9826680f-5cd4-4548-9a39-60eb091e58f2', w: 1024, h: 1024, prompt: `infinity gauntlet spaceship`},
    {id: 'af2a7c0a-be8f-458d-a582-6c5a0f00e406', w: 2048, h: 2048, prompt: `infinity gauntlet spaceship`},
    {id: 'a9b5bd52-5989-42ef-b6f1-90ff75201727', w: 2304, h: 1024, prompt: `city made of human internal parts, bird eye view`},
    {id: '05562c53-fe19-4ec6-a3df-8f1e3f507fc7', w: 1024, h: 1024, prompt: `liver organ doing karate, Impressionism`},
    {id: '9105e83a-4bf4-4cad-a002-091b6c2e807c', w: 1024, h: 1024, prompt: `baby bear thanos`},
    {id: '28b40b6b-2c31-4f89-b9aa-cbeeed53f899', w: 1792, h: 1024, prompt: `one wooden rocket with metal plates fixtures, children crayon drawing on paper`},
    {id: '815449fd-8fc5-4991-964b-93351a0f6826', w: 2048, h: 2048, prompt: `steampunk fish`},
    {id: 'cbe6dc5b-5401-441e-80f3-47b4b7cc2915', w: 1024, h: 1024, prompt: `haruhi suzumiya`},
    {id: 'ac8bdf8a-d7ff-4a97-a0ea-3f52eee22e5d', w: 896, h: 512, prompt: `she sells sea shells by the sea shore`},
    {id: '08e8ca60-e330-4a0f-b677-ccf7e5f17bc1', w: 2048, h: 2048, prompt: `pearl necklace on red dress, 8k sculpture, cinematic, octane renderer`},
    {id: '5c32d5f8-861c-493f-b98e-4fb0a4734d7a', w: 1792, h: 1024, prompt: `floating house on a lake, photorealistic, peaceful`},
    {id: '554959ca-cdfc-4013-bbdf-98fac4b595e3', w: 1792, h: 1024, prompt: `macrophotography of butterfly with flower petal wings, abstract`},
    {id: 'ec0a09bd-c053-47a3-804d-5b46a960a964', w: 1280, h: 1024, prompt: `do not go gentle into that good night`},
    {id: 'aba2dcec-9852-41c5-af2a-4e56d356306d', w: 2048, h: 1152, prompt: `dreamy crystal butterfly, shifted perspective`},
    {id: 'cf77943e-dc69-49cb-897e-4efc9b3d4cc6', w: 1664, h: 1664, prompt: `crystal butterfly in a dream`},
    {id: '9c8420b0-4a42-45c9-8d87-414a89f7b304', w: 1152, h: 2048, prompt: `eclipse in a bottle`},
    {id: '49fc4fed-d20b-4706-b1fb-2f40eaa39c83', w: 1536, h: 2688, prompt: `eclipse in a bottle`},
    {id: 'fb422f6e-d87a-45a7-b6e8-1b8f70f2bd61', w: 1664, h: 1664, prompt: `old stamp of a futuristic city in birds eye view, instagram filter`},
    {id: '88be2db6-c39f-436b-89c5-753698855fc6', w: 1024, h: 1024, prompt: `old stamp of a futuristic city in birds eye view, instagram filter`},
    {id: '6f359cb3-0976-4945-8cfd-f56b70ad7527', w: 1664, h: 1664, prompt: `cyberpunk haruhi suzumiya, anime style`},
    {id: '6154dfaf-bbf1-4bec-bf4c-d4f2825fc103', w: 2304, h: 1024, prompt: `iphone inside a capped glass bottle lying horizontally on an old table`},
    {id: '1890c313-dbae-4f2f-b8f6-f2c9735ff190', w: 2304, h: 1024, prompt: `asian girl eating a soup dumpling in a fancy chinese restaurant, closed-up impressionism, peaceful`},
    {id: '74db9b64-2af6-4499-bfea-09b76ff8eedc', w: 2304, h: 1024, prompt: `futuristic solarpunk city, bird's eyes view, traditional red asian buildings wrapped in green vegetations, unreal engine`},
    {id: 'ea29a59f-2c0c-43d3-bcea-9c080d1b78ea', w: 1536, h: 1536, prompt: `golden retriever puppy wearing a helmet, against a beautiful galaxy, octane renderer`},
    {id: 'e69d238a-4d71-4fe3-9f4b-5a3ac471f5b2', w: 1664, h: 1664, prompt: `pretty dress blowing in the wind`},
    {id: '0417c327-5eac-441e-923f-9736dcd8e380', w: 1664, h: 1664, prompt: `closed up macrophotography of a bowl of asian dessert`},
    {id: '0740ff12-0b35-4905-8dad-bf550a84cb27', w: 1024, h: 1024, prompt: `closed up macrophotography of a bowl of asian dessert`},
    {id: '8aa7fd74-73ea-4831-a48a-ce9edc67d414', w: 2048, h: 1152, prompt: `asian girl in straw hat and white dress, clear sunny sky, sunflower field, portrait photography`},
    {id: '8ee2a580-a6a1-4356-81d1-40e9bc01f5e2', w: 1024, h: 1024, prompt: `so much depends upon a red wheel barrow glazed with rain water beside the white chickens`},
    {id: 'e21ccdd0-4efe-4058-b176-d96c6c673642', w: 1408, h: 1792, prompt: `three-body problem, cinematic`},
    {id: '19a138c9-8d56-471f-bc08-351fda122b5e', w: 1408, h: 1792, prompt: `three-body problem, cinematic`},
    {id: '14465d26-a41e-4cc7-9a70-c7de8a0e28b3', w: 1408, h: 1792, prompt: `three-body problem, cinematic`},
  ].map((d, i) => {
    const ar = d.w / d.h
    const sizeX = Math.min(d.w, boxMaxSizeX, imgMaxSizeY * ar)
    const sizeY = sizeX / ar + promptSizeY
    // upon zooming into 1D mode (big image), swapping out an img src for a higher-res one would cause a flash of blank image in certain cases. Instead, we put the low-res image as a background-image on the container, then the high-res image as a real img on top. Hand-rolled double buffering...
    let node = document.createElement('div')
        node.className = 'box'
        // node.tabIndex = i + 1 // uncomment when dismiss focus isn't this ugly blue hue anymore
        node.style.backgroundImage = `url(https://mj-gallery.com/${d.id}/grid_0_384_N.webp)` // 128 is the next smallest. Too small for retina screens
    let img = document.createElement('img')
        // img.decoding = 'async'
    let promptNode = document.createElement('figcaption')
        promptNode.className = 'prompt'
        promptNode.textContent = d.prompt
    node.append(img, promptNode)
    return {
      id: d.id,
      naturalSizeX: d.w,
      ar, // aspect ratio
      sizeX: {pos: sizeX, v: 0},
      sizeY: {pos: sizeY, v: 0},
      top: {pos: windowSizeY + Math.floor(i / cols) * imgMaxSizeY, v: 0},
      left: {pos: Math.floor(i / cols) * -windowSizeX - windowSizeX, v: 0},
      scale: {pos: 1, v: 0},
      fxFactor: {pos: 20, v: 0}, // for brightness and blur
      node,
    }
  })
}

function step_(config, destPos) {
  // https://blog.maximeheckel.com/posts/the-physics-behind-spring-animations/
  // lol this totally seems copied from https://github.com/chenglou/react-motion/blob/9e3ce95bacaa9a1b259f969870a21c727232cc68/src/stepper.js
  const k = 225, b = 27, t = simulationStep / 1000
  const {pos, v} = config
  // for animations, destPos is really spring length (spring at rest). initial
  // position is considered as the stretched/compressed position of a spring
  const Fspring = -k * (pos - destPos) // Spring stiffness, in kg / s^2
  const Fdamper = -b * v // Damping, in kg / s

  // usually we put mass here, but for animation purposes, specifying mass is a
  // bit redundant. you could simply adjust k and b accordingly
  // let a = (Fspring + Fdamper) / mass
  const a = Fspring + Fdamper
  const newV = v + a * t
  const newX = pos + newV * t

  config.pos = newX
  config.v = newV
}

function stepAnimation_(d, frames, boxSizeX, boxSizeY, top, left, scale, fxFactor) {
  for (let i = 0; i < frames; i++) {
    step_(d.sizeX, boxSizeX)
    step_(d.sizeY, boxSizeY)
    step_(d.top, top)
    step_(d.left, left)
    step_(d.scale, scale)
    step_(d.fxFactor, fxFactor)
  }
  let stillAnimating = false
  if (Math.abs(d.sizeX.v)    < 0.01 && Math.abs(boxSizeX - d.sizeX.pos)    < 0.01) {d.sizeX.v    = 0; d.sizeX.pos    = boxSizeX} else stillAnimating = true
  if (Math.abs(d.sizeY.v)    < 0.01 && Math.abs(boxSizeY - d.sizeY.pos)    < 0.01) {d.sizeY.v    = 0; d.sizeY.pos    = boxSizeY} else stillAnimating = true
  if (Math.abs(d.top.v)      < 0.01 && Math.abs(top - d.top.pos)           < 0.01) {d.top.v      = 0; d.top.pos      = top     } else stillAnimating = true
  if (Math.abs(d.left.v)     < 0.01 && Math.abs(left - d.left.pos)         < 0.01) {d.left.v     = 0; d.left.pos     = left    } else stillAnimating = true
  if (Math.abs(d.scale.v)    < 0.01 && Math.abs(scale - d.scale.pos)       < 0.01) {d.scale.v    = 0; d.scale.pos    = scale   } else stillAnimating = true
  if (Math.abs(d.fxFactor.v) < 0.01 && Math.abs(fxFactor - d.fxFactor.pos) < 0.01) {d.fxFactor.v = 0; d.fxFactor.pos = fxFactor} else stillAnimating = true
  return stillAnimating
}

// === state. Plus one in the URL's hash
let lastAnimatedRenderTime = null
let zIndex = 1
let inputs = {
  pointer: {x: -1, y: -1}, // btw, on page load, there's no way to render a first cursor state =(
  key: null,
  clickedTarget: null,
}
// === debug
const debug = false // only need to toggle this
let debugTimestamp = 0
const raf = debug ? function raf(f) {
    debugTimestamp += 1000 / 60
    f(debugTimestamp)
} : requestAnimationFrame

window.addEventListener('resize', () => scheduleRender())
window.addEventListener('scroll', () => scheduleRender())
window.addEventListener('keydown', (e) => {
  if (e.code === 'Escape' || e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
    inputs.key = e.code
    scheduleRender()
  } else if (e.code === 'KeyA') { // debug
    scheduleRender(true)
  }
})
window.addEventListener('click', (e) => {
  inputs.clickedTarget = e.target
  scheduleRender()
})
window.addEventListener('pointermove', (e) => {
  // when scrolling (which updates `render`), a container's pointermove doesn't trigger; e.offsetX/Y (coordinates local
  // to container) would be stale. So we have to use global coords anyway. Might as well attach to window
  // We need to listen window-wide anyway, since custom selection needs to know when the cursor dragged into a comment from outside
  inputs.pointer.x = e.pageX; inputs.pointer.y = e.pageY // can exceed document bounds, e.g. dragging reports back out-of-bound values
  scheduleRender()
})
// safari pointerdown isn't fired on the first left click after dismissing context menus... back to mousedown
window.addEventListener('mousedown', (e) => {
  // also update position. Maybe pointer never moved (page refresh, right click, move, then left click to dismiss, etc.)
  inputs.pointer.x = e.pageX; inputs.pointer.y = e.pageY
  scheduleRender()
})
window.addEventListener('popstate', (e) => {
  scheduleRender()
})

let dummyPlaceholder = document.createElement('div')
dummyPlaceholder.style.width = '1px' // make it tiny just in case it affects compositing... sigh
document.body.append(dummyPlaceholder)

let scheduled = false
function scheduleRender(debugForceRender) {
  if (debug && !debugForceRender) return;
  if (scheduled) return;
  scheduled = true

  raf(function render(now) {
    // batched DOM reads
    // excludes scroll bar & invariant under safari pinch zoom
    const windowSizeX = document.documentElement.clientWidth
    // invariant under safari pinch zoom (this way, when zoomed in, we don't occlude away rows outside of the zoomed-in view; if we did, when we zoom out again we wouldn't see those occluded rows until we release our fingers. During safari pinch, no event is triggered so we couldn't have updated the occlusion in real time)
    const windowSizeY = document.documentElement.clientHeight
    let scrollTop = window.scrollY
    // don't forget top & bottom safari UI chrome sizes when vertically occluding, since they're transluscent so we can't over-occlude by ignoring them
    const UIMaxSizeTop = 100, UIMaxSizeBottom = 150 // random conservative numbers

    const {cols, boxMaxSizeX} = colsBoxMaxSizeXF(windowSizeX)
    const {pointer} = inputs
    const hitArea1DSizeX = 100 // left and right click region in 1D mode
    const box1DMaxSizeX = windowSizeX - boxes1DGapX * 2 - hitArea1DSizeX * 2
    const img1DSizeY = windowSizeY - boxes1DGapY * 2 - prompt1DSizeY - promptGapBottom // TODO: adjust
    if (lastAnimatedRenderTime == null) lastAnimatedRenderTime = now // TODO: state mutation only at the end

    const hashImgId = window.location.hash.slice(1)
    let active = null; for (let i = 0; i < data.length; i++) if (data[i].id === hashImgId) active = i

    // handle key
    let newActive
    let edgeRubberBandVelocityX = 0
    if (inputs.key === 'Escape') {
      newActive = null
    } else if (inputs.key === 'ArrowLeft') {
      if (active == null) {
        newActive = 0
      } else if (active === 0) {
        newActive = 0
        edgeRubberBandVelocityX = 2000
      } else {
        newActive = active - 1
      }
      data[newActive].node.style.zIndex = zIndex++
    } else if (inputs.key === 'ArrowRight') {
      if (active == null) {
        newActive = 0
      } else if (active === data.length - 1) {
        newActive = data.length - 1
        edgeRubberBandVelocityX = -2000
      } else {
        newActive = active + 1
      }
      data[newActive].node.style.zIndex = zIndex++
    } else {
      newActive = active
    }
    // handle click
    const pointerPlace1D =
      pointer.x >= 0 && pointer.x <= hitArea1DSizeX ? 'left'
      : pointer.x >= windowSizeX - hitArea1DSizeX ? 'right'
      : null
    if (inputs.clickedTarget != null) {
      const tagName = inputs.clickedTarget.tagName
      if (tagName === 'FIGCAPTION') { // select the whole prompt
        let selection = window.getSelection()
        let range = document.createRange()
        range.selectNodeContents(inputs.clickedTarget)
        selection.removeAllRanges()
        selection.addRange(range)
      } else if (active > 0 && pointerPlace1D === 'left') {
        // allow spamming clicks without accidentally clicking on an empty region on left/right side (and dismiss 1D mode) during transition
        newActive = Math.max(active - 1, 0)
      } else if (active != null && active < data.length - 1 && pointerPlace1D === 'right') {
        newActive = Math.min(active + 1, data.length - 1)
      } else if ((tagName === 'DIV' && inputs.clickedTarget.className === 'box') || tagName === 'IMG') {
        let node = tagName === 'DIV' ? inputs.clickedTarget : inputs.clickedTarget.parentNode
        for (let i = 0; i < data.length; i++) {
          if (data[i].node === node) {
            if (active === i) {
              newActive = null
            } else {
              newActive = i
              node.style.zIndex = zIndex++
            }
            break
          }
        }
      } else {
        newActive = null
      }
    }

    let imgs = [], rowsTop = [boxesGapY] // length: number of rows + 1
    {
      let rowMaxSizeY = 0
      for (let i = 0; i < data.length; i++) {
        let d = data[i]
        const imgMaxSizeY =
          d.ar === 1 ? boxMaxSizeX * 0.9 // square aspect ratio area too big. Shrink it
          : d.ar < 1 ? boxMaxSizeX * 1.05 // vertical images look a bit small. Grow it
          : boxMaxSizeX
        const sizeX = Math.min(d.naturalSizeX, boxMaxSizeX, imgMaxSizeY * d.ar)
        const sizeY = sizeX / d.ar
        imgs.push({sizeX, sizeY})
        rowMaxSizeY = Math.max(rowMaxSizeY, sizeY)
        if (i % cols === cols - 1 || i === data.length - 1) {
          rowsTop.push(rowsTop[Math.floor(i / cols)] + rowMaxSizeY + promptSizeY + promptGapBottom + boxesGapY)
          rowMaxSizeY = 0
        }
      }
    }

    let newScrollTop = null // can't be initialized to scrollTop; scrollTop upon read is rounded off, so scrollTop !== scrollTop potentially...
    let stillAnimating = false
    const deltaTime = (now - lastAnimatedRenderTime) / simulationStep
    const frames = Math.floor(deltaTime)
    lastAnimatedRenderTime += frames * simulationStep
    if (newActive != null) {
      let currentLeft = hitArea1DSizeX + boxes1DGapX
      for (let i = newActive - 1; i >= 0; i--) {
        let d = data[i]
        const imgSizeX = Math.min(d.naturalSizeX, box1DMaxSizeX, img1DSizeY * d.ar) * 0.7
        currentLeft -= imgSizeX + boxes1DGapX
      }

      for (let i = 0; i < data.length; i++) {
        let d = data[i]
        const imgSizeX = Math.min(d.naturalSizeX, box1DMaxSizeX, img1DSizeY * d.ar) * (i === newActive ? 1 : 0.7)
        const imgSizeY = imgSizeX / d.ar
        const boxSizeX = imgSizeX
        const boxSizeY = imgSizeY + prompt1DSizeY + promptGapBottom
        let top = scrollTop + (windowSizeY - boxSizeY) / 2
        let left = i === newActive ? (windowSizeX - imgSizeX) / 2 : currentLeft
        let scale, fxFactor
        if ((pointerPlace1D === 'left' && i === newActive - 1) || (pointerPlace1D === 'right' && i === newActive + 1)) { // hovering
          left += (pointer.x - (left + boxSizeX / 2)) / 40
          top += (pointer.y - (top + boxSizeY / 2)) / 40
          scale = 1.02
          fxFactor = 0.5
        } else {
          scale = 1
          fxFactor = i === newActive ? 1 : 0.2
        }

        d.left.v += edgeRubberBandVelocityX / (i === newActive ? 1 : 4)
        stillAnimating |= stepAnimation_(d, frames, boxSizeX, boxSizeY, top, left, scale, fxFactor)

        currentLeft = i === newActive ? windowSizeX - hitArea1DSizeX : currentLeft + imgSizeX + boxes1DGapX
      }
    } else {
      if (newActive == null && active != null) { // just dismissed zoom in
        const activeTop = rowsTop[Math.floor(active / cols)]
        const boxSizeY = imgs[active].sizeY + promptSizeY + promptGapBottom
        // if the dismissed box isn't fully shown, scroll there
        if (activeTop <= scrollTop || activeTop + boxSizeY >= scrollTop + windowSizeY) {
          newScrollTop = activeTop - boxesGapY - 40 // Peek a little higher to show the previous row
          const delta = newScrollTop - scrollTop
          scrollTop = newScrollTop
          for (let i = 0; i < data.length; i++) data[i].top.pos += delta // magically & seamlessly zoom out from 1D mode's focused active box without vertical jitter
        }
      }

      for (let i = 0; i < data.length; i++) {
        let d = data[i]
        const currentRow = Math.floor(i / cols)
        const boxSizeX = imgs[i].sizeX
        const boxSizeY = imgs[i].sizeY + promptSizeY + promptGapBottom
        const rowMaxSizeY = rowsTop[currentRow + 1] - rowsTop[currentRow]
        let top = rowsTop[currentRow] + (rowMaxSizeY - boxSizeY) / 2
        let left = boxesGapX + (boxMaxSizeX + boxesGapX) * (i % cols) + (boxMaxSizeX - boxSizeX) / 2 // center horizontally
        let scale
        if (left <= pointer.x && pointer.x <= left + boxSizeX && top <= pointer.y && pointer.y <= top + boxSizeY) { // hovering
          left += (pointer.x - (left + boxSizeX / 2)) / 40
          top += (pointer.y - (top + boxSizeY / 2)) / 40
          scale = 1.02
        } else {
          scale = 1
        }
        const fxFactor = 1

        stillAnimating |= stepAnimation_(d, frames, boxSizeX, boxSizeY, top, left, scale, fxFactor)
      }

    }

    for (let i = 0; i < data.length; i++) {
      let d = data[i]
      let {node} = d
      // only draw what's visible on screen
      if (
        d.top.pos <= scrollTop + windowSizeY + UIMaxSizeBottom &&
        d.top.pos + d.sizeY.pos >= scrollTop - UIMaxSizeTop &&
        d.left.pos <= windowSizeX &&
        d.left.pos + d.sizeX.pos >= 0
      ) { // disregard shadow & scaling for now; UIMaxSizeBottom and UIMaxSizeTop are safe bigger values anyway
        node.style.width = `${d.sizeX.pos}px`
        node.style.height = `${d.sizeY.pos}px`
        node.style.transform = `translate3d(${d.left.pos}px,${d.top.pos}px,0) scale(${d.scale.pos})` // safari now anti-aliases for hover, but then zoom in janks on big displays...
        // we can't afford fxFactor & blur for all pics; too expensive for Safari & Chrome. E.g. when zomming out of a photo, keep scrolling; Chrome stops render on Studio Display
        node.style.filter = newActive != null && i === newActive - 1 || i === newActive || i === newActive + 1
          ? `brightness(${d.fxFactor.pos * 100}%) blur(${Math.max(0, 6 - d.fxFactor.pos * 6)}px)` // blur these 3 only
          : `brightness(${d.fxFactor.pos * 100}%)` // blur of unrelated pics is too fast during transition from/to 1D mode to be seen anyway

        let img = node.children[0], prompt = node.children[1]
        const imgSizeY = d.sizeX.pos / d.ar
        prompt.style.top = `${imgSizeY}px`

        if (i === newActive) {
          node.style.cursor = 'zoom-out'
          prompt.style.overflowY = 'auto'
          prompt.style.height = `${prompt1DSizeY}px`
          prompt.style.lineClamp = prompt.style.webkitLineClamp = 999
          img.style.display = 'block'
          let src = `https://mj-gallery.com/${d.id}/grid_0.webp`
          if (!stillAnimating && img.src !== src) img.src = src // load the full res image
        } else {
          node.style.cursor = 'zoom-in'
          prompt.style.overflowY = 'hidden'
          prompt.style.height = `${promptSizeY}px`
          prompt.style.lineClamp = prompt.style.webkitLineClamp = 2
          img.style.display = 'none' // hide full res image for perf (yes it makes a difference, even on M1, with Studio Display)
        }
        if (node.parentNode == null) document.body.appendChild(node) // if previously absent, add
      } else if (node.parentNode != null) document.body.removeChild(node) // if previously present, remove
    }

    if (newActive === null) {
      document.body.style.cursor = 'auto'
      document.body.style.overflowY = 'auto'
    } else {
      document.body.style.cursor = pointerPlace1D === 'left' || pointerPlace1D === 'right' ? 'zoom-in' : 'zoom-out'
      document.body.style.overflowY = 'hidden'
    }
    dummyPlaceholder.style.height = `${rowsTop[rowsTop.length - 1]}px`
    if (newScrollTop != null) window.scrollTo({top: newScrollTop}) // Chrome has race conditon when expanding the last row of images if scrollTo is called before dummy height setting
    if (newActive !== active) {
      window.history.pushState(null, null, `${window.location.pathname}${window.location.search}${newActive == null ? '' : '#' + data[newActive].id}`)
    }

    // === prepare for next frame
    scheduled = false
    inputs.key = null
    inputs.clickedTarget = null
    active = newActive
    if (stillAnimating) {
      scheduleRender()
    } else {
      lastAnimatedRenderTime = null
    }
  })
}

scheduleRender()
</script>

</body>

</html>
